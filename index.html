<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Temporary Charts - Sujal Khanal Edition</title>
    
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; background: #76ba1b; font-family: 'Fredoka One', cursive; color: #444; overflow: hidden; }
        #canvas-container { position: fixed; inset: 0; z-index: -1; }
        .box { width: 420px; max-width: 95%; background: rgba(255, 255, 255, 0.95); border: 4px solid #2d5a27; border-radius: 30px; box-shadow: 8px 8px 0px #1e3d1a; padding: 25px; display: flex; flex-direction: column; height: 80vh; justify-content: space-between; position: relative; z-index: 10; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .char-option { font-size: 30px; padding: 10px; border: 3px solid #eee; border-radius: 15px; cursor: pointer; text-align: center; background: white; }
        .selected { background: #FFD93D; border: 3px solid #000; }
        input, button { border: 3px solid #2d5a27; padding: 12px; border-radius: 12px; font-family: inherit; font-size: 16px; outline: none; }
        button { background: #76ba1b; color: white; cursor: pointer; }
        .chat { flex: 1; overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 12px; scrollbar-width: none; position: relative; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 18px; border: 2px solid #2d5a27; background: #fff; position: relative; word-wrap: break-word; transition: opacity 0.6s, transform 0.6s; }
        .vanish { opacity: 0; transform: translateY(-20px) scale(0.9); pointer-events: none; }
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .avatar-circle { background: #FFD93D; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 1px solid #000; }
        .sender-name { font-size: 12px; color: #2d5a27; }
        .system-msg { align-self: center; font-size: 11px; background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 20px; color: #4b6e44; border: 1px dashed #2d5a27; }
        .right { align-self: flex-end; background: #e2f0d9; }
        .hidden { display: none !important; }
        
        .credit { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #fff; text-shadow: 1px 1px #1e3d1a; pointer-events: none; z-index: 1; opacity: 0.8; width: 100%; text-align: center; }

        #typingBox { font-size: 12px; color: #2d5a27; height: 20px; font-style: italic; margin-bottom: 5px; opacity: 0; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        #godMode { position: absolute; inset: 0; background: rgba(10, 20, 10, 0.98); border-radius: 26px; color: #00ff00; display: flex; flex-direction: column; padding: 20px; font-family: 'Courier New', monospace; z-index: 100; border: 2px solid #00ff00; }
        .god-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .god-btn { background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 8px; cursor: pointer; font-size: 11px; }

        #callOverlay { position: absolute; inset: 0; background: #1a2a3a; border-radius: 26px; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; backdrop-filter: blur(15px); overflow: hidden; }
        .ringing { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .call-btn-row { position: absolute; bottom: 40px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 210; }
        .c-btn { width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 22px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .blue { background: #3498db; } .red { background: #e74c3c; } .green { background: #2ecc71; } .gray { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        
        #remoteVideo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; background: #000; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 12px; border: 2px solid white; object-fit: cover; z-index: 206; background: #222; cursor: move; touch-action: none; }
        
        #callTimer { font-size: 14px; margin-top: 5px; color: #2ecc71; font-weight: bold; }
        #minBtn { position: absolute; top: 20px; left: 20px; z-index: 220; font-size: 24px; cursor: pointer; }
        #restoreCall { position: absolute; top: 10px; left: 10px; background: #2ecc71; padding: 5px 10px; border-radius: 15px; color: white; font-size: 10px; cursor: pointer; z-index: 150; animation: pulse 2s infinite; }

        .invalid-input { border-color: #ff4757 !important; background: #fff1f2; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        #roomErr { color: #ff4757; font-size: 12px; margin-top: 5px; text-align: center; height: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div class="credit">Created by üåø <b>Sujal Khanal</b></div>

<div class="box" id="setupScreen">
    <div style="text-align:center; font-size: 24px;">PICK AVATAR</div>
    <div class="char-grid">
        <div class="char-option selected" onclick="sel(this, 'ü¶Å')">ü¶Å</div>
        <div class="char-option" onclick="sel(this, 'üêµ')">üêµ</div>
        <div class="char-option" onclick="sel(this, 'üêØ')">üêØ</div>
        <div class="char-option" onclick="sel(this, 'üêò')">üêò</div>
    </div>
    <input id="username" placeholder="Explorer Name...">
    <button onclick="toRoom()">NEXT</button>
</div>

<div class="box hidden" id="roomScreen">
    <div style="text-align:center; font-size: 24px;">ROOM SETUP</div>
    <button onclick="createRoom()">‚ûï CREATE NEW ROOM</button>
    <div style="text-align:center; margin: 10px;">OR</div>
    <input id="inviteInput" placeholder="Enter Room Code.." oninput="this.classList.remove('invalid-input'); document.getElementById('roomErr').innerText='';">
    <div id="roomErr"></div>
    <button onclick="joinRoom()" style="background:#4facfe;">üîó JOIN ROOM</button>
</div>

<div class="box hidden" id="chatScreen">
    <div id="restoreCall" class="hidden" onclick="maximizeCall()">üü¢ CALL ACTIVE</div>
    <div id="callOverlay" class="hidden">
        <i id="minBtn" class="fas fa-chevron-down" onclick="minimizeCall()"></i>
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted class="hidden"></video>
        
        <div id="callUI" style="z-index: 205; position: relative;">
            <h1 id="cAvatar" class="ringing" style="font-size: 80px; margin:0;">ü¶Å</h1>
            <h2 id="cName">Sujal</h2>
            <p id="cStatus">Calling...</p>
            <div id="callTimer" class="hidden">00:00</div>
        </div>

        <div id="incBtns" class="call-btn-row hidden">
            <button class="c-btn red" onclick="hangup()"><i class="fas fa-times"></i></button>
            <button class="c-btn green" onclick="acceptCall()"><i class="fas fa-phone"></i></button>
        </div>

        <div id="actBtns" class="call-btn-row hidden">
            <button id="mBtn" class="c-btn blue" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button id="vBtn" class="c-btn blue" onclick="toggleCam()"><i class="fas fa-video"></i></button>
            <button class="c-btn gray" onclick="switchCam()"><i class="fas fa-camera-rotate"></i></button>
            <button class="c-btn red" onclick="hangup()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <div id="godMode" class="hidden">
        <h3 style="text-align:center;">‚ö° GOD MODE ACTIVE</h3>
        <div class="god-grid">
            <button class="god-btn" onclick="tVanish()">üëª VANISH: <span id="vStat">OFF</span></button>
            <button class="god-btn" onclick="startCall('audio')">üìû AUDIO CALL</button>
            <button class="god-btn" onclick="startCall('video')">üé• VIDEO CALL</button>
            <button class="god-btn" onclick="document.getElementById('fInput').click()">üìÅ SHARE FILE</button>
            <input type="file" id="fInput" class="hidden" onchange="sendFile(this)">
            <button class="god-btn" style="grid-column: span 2; color:red;" onclick="nuke()">‚ò¢Ô∏è SELF-DESTRUCT</button>
            <button class="god-btn" style="grid-column: span 2;" onclick="document.getElementById('godMode').classList.add('hidden')">CLOSE</button>
        </div>
    </div>

    <div id="roomInfo" class="system-msg" style="margin-bottom: 5px; font-weight: bold;">Code: ‚Äî</div>
    <div class="chat" id="messages"></div>
    <div id="typingBox"></div>
    <div style="display:flex; gap:8px;">
        <input id="text" placeholder="Messages..." style="flex:1;">
        <button onclick="send()">SEND</button>
    </div>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);
    const group = new THREE.Group(); scene.add(group); camera.position.z = 12;
    let mx = 0, my = 0;
    window.addEventListener('mousemove', (e) => { mx = (e.clientX-window.innerWidth/2)/120; my = (e.clientY-window.innerHeight/2)/120; });
    window.spawnPlayer = (e) => {
        const can = document.createElement('canvas'); can.width=128; can.height=128;
        const ctx = can.getContext('2d'); ctx.font='80px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(e, 64, 64);
        const spr = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(can)}));
        spr.position.set((Math.random()-0.5)*18, (Math.random()-0.5)*12, 0); spr.scale.set(2.5,2.5,1); group.add(spr);
    };
    function animate() { requestAnimationFrame(animate); group.position.x += (mx-group.position.x)*0.05; group.position.y += (-my-group.position.y)*0.05; renderer.render(scene, camera); }
    animate();
</script>

<script>
    let ws, username, emoji="ü¶Å", room, vanish=false, stream, mic=true, cam=true, pc, camMode="user";
    let startTime, timerInterval;
    const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
    ws = new WebSocket(protocol + location.host);
    const iceCfg = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    
    const joinSfx = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    const msgSfx = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');
    const ringSfx = new Audio('https://assets.mixkit.co/active_storage/sfx/1353/1353-preview.mp3');
    ringSfx.loop = true;

    const lv = document.getElementById('localVideo');
    let isDragging = false, offset = [0,0];
    lv.addEventListener('pointerdown', e => { isDragging = true; offset = [lv.offsetLeft - e.clientX, lv.offsetTop - e.clientY]; lv.setPointerCapture(e.pointerId); });
    lv.addEventListener('pointermove', e => { if (!isDragging) return; lv.style.left = (e.clientX + offset[0]) + 'px'; lv.style.top = (e.clientY + offset[1]) + 'px'; lv.style.right = 'auto'; });
    lv.addEventListener('pointerup', e => isDragging = false);

    function minimizeCall() { document.getElementById("callOverlay").classList.add("hidden"); document.getElementById("restoreCall").classList.remove("hidden"); }
    function maximizeCall() { document.getElementById("callOverlay").classList.remove("hidden"); document.getElementById("restoreCall").classList.add("hidden"); }

    ws.onmessage = async (e) => {
        const data = JSON.parse(e.data);
        const chat = document.getElementById("messages");

        if (data.type === "join_success") {
            room = data.room;
            document.getElementById("roomScreen").classList.add("hidden");
            document.getElementById("chatScreen").classList.remove("hidden");
            document.getElementById("roomInfo").innerText = "CODE: " + (room === "BIBROO_ROOM" ? "BIBR00" : room);
            window.spawnPlayer(emoji);
        }
        if (data.type === "error") {
            const inp = document.getElementById("inviteInput");
            inp.classList.add("invalid-input");
            document.getElementById("roomErr").innerText = data.message;
        }
        if (data.type === "message") {
            const m = data.message;
            if (m.sender !== username) msgSfx.play().catch(()=>{});
            const d = document.createElement("div"); d.className = "msg " + (m.sender === username ? "right" : "");
            let fileH = m.file ? (m.file.startsWith("data:image") ? `<img src="${m.file}" style="max-width:100%; border-radius:10px; margin-top:8px;">` : "") + `<br><a href="${m.file}" download="${m.fileName}" style="color:#76ba1b; font-size:12px;">üìé Download</a>` : "";
            d.innerHTML = `<div class="msg-header"><div class="avatar-circle">${m.avatar}</div><span class="sender-name">${m.sender}</span></div><div>${m.text}</div>${fileH}`;
            chat.appendChild(d); chat.scrollTop = chat.scrollHeight;
            if (m.disappear) {
                setTimeout(() => { d.classList.add('vanish'); setTimeout(() => d.remove(), 600); }, 10000);
            }
        }
        if (data.type === "typing" && data.sender !== username) {
            const tBox = document.getElementById("typingBox");
            if(data.isTyping) {
                tBox.innerHTML = `<div class="avatar-circle" style="width:18px;height:18px;font-size:10px">${data.avatar}</div> ${data.sender} is typing...`;
                tBox.style.opacity = "1";
            } else { tBox.style.opacity = "0"; }
        }
        if (data.type === "system") {
            const s = document.createElement("div"); s.className="system-msg"; s.innerText=data.text;
            chat.appendChild(s); if(data.text.includes("joined")) joinSfx.play().catch(()=>{});
        }
        
        if (data.type === "call_req" && data.sender !== username) {
            document.getElementById("callOverlay").classList.remove("hidden");
            document.getElementById("incBtns").classList.remove("hidden");
            document.getElementById("actBtns").classList.add("hidden");
            document.getElementById("cName").innerText = data.sender;
            document.getElementById("cAvatar").innerText = data.senderAvatar || "ü¶Å";
            ringSfx.play().catch(()=>{});
        }
        if (data.type === "call_acc" && data.sender !== username) {
            ringSfx.pause();
            startTimer();
            if(!pc) initPeer();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: "offer", offer }));
        }
        if (data.type === "offer" && data.sender !== username) {
            ringSfx.pause();
            startTimer();
            if(!pc) initPeer();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", answer }));
        }
        if (data.type === "answer" && data.sender !== username) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
        if (data.type === "candidate" && data.sender !== username) {
            if(pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
        if (data.type === "hangup") endCallLogic();
        if (data.type === "wipe_chat") chat.innerHTML = "";
    };

    function sel(el, e) { document.querySelectorAll('.char-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); emoji=e; }
    function toRoom() { username=document.getElementById("username").value.trim(); if(username){ document.getElementById("setupScreen").classList.add("hidden"); document.getElementById("roomScreen").classList.remove("hidden"); } }
    function createRoom() {
        const newCode = Math.random().toString(36).substr(2,6).toUpperCase();
        ws.send(JSON.stringify({ type: "generate_code", code: newCode }));
        ws.send(JSON.stringify({ type: "join", room: newCode, username, avatar: emoji }));
    }
    function joinRoom() {
        const val = document.getElementById("inviteInput").value.trim().toUpperCase();
        ws.send(JSON.stringify({ type: "join", room: val, username, avatar: emoji }));
    }
    function tVanish() { vanish=!vanish; document.getElementById("vStat").innerText=vanish?"ON":"OFF"; }
    function send() {
        const i = document.getElementById("text");
        if(i.value === "/bibr") { document.getElementById("godMode").classList.remove("hidden"); i.value=""; return; }
        if(i.value.trim()){ 
            ws.send(JSON.stringify({type:"message", text:i.value, disappear: vanish})); 
            i.value=""; 
            ws.send(JSON.stringify({ type: "typing", isTyping: false, avatar: emoji }));
        }
    }
    function sendFile(el) {
        const file = el.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            ws.send(JSON.stringify({ type: "message", text: `Sent a file: ${file.name}`, file: reader.result, fileName: file.name, disappear: vanish }));
        };
        reader.readAsDataURL(file);
    }
    
    function startTimer() {
        document.getElementById("callTimer").classList.remove("hidden");
        document.getElementById("cStatus").innerText = "In Call";
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById("callTimer").innerText = `${m}:${s}`;
        }, 1000);
    }

    async function startCall(t) {
        document.getElementById("godMode").classList.add("hidden");
        document.getElementById("callOverlay").classList.remove("hidden");
        document.getElementById("actBtns").classList.remove("hidden");
        document.getElementById("incBtns").classList.add("hidden");
        document.getElementById("cStatus").innerText = "Calling...";
        
        stream = await navigator.mediaDevices.getUserMedia({ audio:true, video: t==='video' });
        document.getElementById("localVideo").srcObject = stream;
        document.getElementById("localVideo").classList.remove("hidden");
        
        initPeer();
        ws.send(JSON.stringify({ type: "call_req", callType: t, senderAvatar: emoji }));
    }

    async function acceptCall() { 
        ringSfx.pause(); ringSfx.currentTime = 0;
        document.getElementById("incBtns").classList.add("hidden"); 
        document.getElementById("actBtns").classList.remove("hidden"); 
        
        stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true }); 
        document.getElementById("localVideo").srcObject = stream;
        document.getElementById("localVideo").classList.remove("hidden");
        
        if(!pc) initPeer(); 
        ws.send(JSON.stringify({ type: "call_acc" })); 
        startTimer();
    }

    function initPeer() { 
        pc = new RTCPeerConnection(iceCfg); 
        if(stream) stream.getTracks().forEach(t => pc.addTrack(t, stream)); 
        pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate })); }; 
        pc.ontrack = e => { 
            document.getElementById("remoteVideo").srcObject = e.streams[0]; 
            document.getElementById("callUI").classList.add("hidden"); 
        }; 
    }

    function toggleMic() { 
        mic = !mic; stream.getAudioTracks()[0].enabled = mic; 
        document.getElementById("mBtn").innerHTML = mic ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        document.getElementById("mBtn").style.background = mic ? '#3498db' : '#e74c3c';
    }

    function toggleCam() { 
        cam = !cam; stream.getVideoTracks()[0].enabled = cam; 
        document.getElementById("vBtn").innerHTML = cam ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        document.getElementById("vBtn").style.background = cam ? '#3498db' : '#e74c3c';
    }

    async function switchCam() {
        if (!stream) return;
        camMode = (camMode === "user") ? "environment" : "user";
        stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({ audio: mic, video: { facingMode: camMode } });
        document.getElementById("localVideo").srcObject = stream;
        const videoTrack = stream.getVideoTracks()[0];
        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(videoTrack);
    }

    function hangup() { ws.send(JSON.stringify({ type: "hangup" })); endCallLogic(); }

    function endCallLogic() { 
        ringSfx.pause(); ringSfx.currentTime = 0;
        clearInterval(timerInterval);
        document.getElementById("callTimer").classList.add("hidden");
        document.getElementById("callTimer").innerText = "00:00";
        if(pc) { pc.close(); pc = null; }
        if(stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
        document.getElementById("callOverlay").classList.add("hidden"); 
        document.getElementById("restoreCall").classList.add("hidden");
        document.getElementById("callUI").classList.remove("hidden"); 
        document.getElementById("localVideo").classList.add("hidden");
        document.getElementById("remoteVideo").srcObject = null;
    }

    let typingTimer;
    document.getElementById("text").addEventListener("input", () => {
        ws.send(JSON.stringify({ type: "typing", isTyping: true, avatar: emoji }));
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => { ws.send(JSON.stringify({ type: "typing", isTyping: false, avatar: emoji })); }, 2000);
    });

    function nuke() { ws.send(JSON.stringify({type:"self_destruct"})); }
    document.getElementById("text").addEventListener("keypress", (e)=>{if(e.key==="Enter")send();});
</script>
</body>
</html>

